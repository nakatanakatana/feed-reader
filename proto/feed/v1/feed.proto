syntax = "proto3";

package feed.v1;

import "tag/v1/tag.proto";

option go_package = "github.com/nakatanakatana/feed-reader/gen/go/feed/v1;feedv1";

service FeedService {
  rpc GetFeed(GetFeedRequest) returns (GetFeedResponse);
  rpc ListFeeds(ListFeedsRequest) returns (ListFeedsResponse);
  rpc CreateFeed(CreateFeedRequest) returns (CreateFeedResponse);
  rpc UpdateFeed(UpdateFeedRequest) returns (UpdateFeedResponse);
  rpc DeleteFeed(DeleteFeedRequest) returns (DeleteFeedResponse);
  rpc RefreshFeeds(RefreshFeedsRequest) returns (RefreshFeedsResponse);
  rpc ImportOpml(ImportOpmlRequest) returns (ImportOpmlResponse);
  rpc GetImportJob(GetImportJobRequest) returns (GetImportJobResponse);

  // Tag management
  rpc SetFeedTags(SetFeedTagsRequest) returns (SetFeedTagsResponse);
  rpc ManageFeedTags(ManageFeedTagsRequest) returns (ManageFeedTagsResponse);
}

message Feed {
  string id = 1;
  string url = 2;
  optional string link = 3;
  string title = 4;
  optional string description = 5;
  optional string lang = 6;
  optional string image_url = 7;
  optional string copyright = 8;
  optional string feed_type = 9;
  optional string feed_version = 10;
  optional string last_fetched_at = 11;
  string created_at = 12;
  string updated_at = 13;
  repeated tag.v1.Tag tags = 14;
  int64 unread_count = 15;
}

message ListFeed {
  string id = 1;
  string url = 2;
  string title = 3;
  int64 unread_count = 4;
  repeated tag.v1.Tag tags = 5;
}

message GetFeedRequest {
  string id = 1;
}

message GetFeedResponse {
  Feed feed = 1;
}

message ListFeedsRequest {
  optional string tag_id = 1;
}

message ListFeedsResponse {
  repeated ListFeed feeds = 1;
}

message CreateFeedRequest {
  string url = 1;
  optional string title = 2;
  optional string link = 3;
  optional string description = 4;
  optional string lang = 5;
  optional string image_url = 6;
  optional string copyright = 7;
  optional string feed_type = 8;
  optional string feed_version = 9;
  repeated string tag_ids = 10;
}

message CreateFeedResponse {
  Feed feed = 1;
}

message UpdateFeedRequest {
  string id = 1;
  optional string title = 3;
  optional string link = 4;
  optional string description = 5;
  optional string lang = 6;
  optional string image_url = 7;
  optional string copyright = 8;
  optional string feed_type = 9;
  optional string feed_version = 10;
  optional string last_fetched_at = 11;
  repeated string tag_ids = 12;
}

message UpdateFeedResponse {
  Feed feed = 1;
}

message DeleteFeedRequest {
  string id = 1;
}

message DeleteFeedResponse {}

message RefreshFeedsRequest {
  repeated string ids = 1;
}

message FeedFetchStatus {
  string feed_id = 1;
  bool success = 2;
  int32 new_items_count = 3;
  optional string error_message = 4;
}

message RefreshFeedsResponse {
  repeated FeedFetchStatus results = 1;
}

message ImportOpmlRequest {
  bytes opml_content = 1;
}

message ImportOpmlResponse {
  int32 total = 1;
  int32 success = 2;
  int32 skipped = 3;
  repeated string failed_feeds = 4;
  string job_id = 5;
}

enum ImportJobStatus {
  IMPORT_JOB_STATUS_UNSPECIFIED = 0;
  IMPORT_JOB_STATUS_QUEUED = 1;
  IMPORT_JOB_STATUS_PROCESSING = 2;
  IMPORT_JOB_STATUS_COMPLETED = 3;
  IMPORT_JOB_STATUS_FAILED = 4;
}

message ImportJob {
  string id = 1;
  ImportJobStatus status = 2;
  int32 total_feeds = 3;
  int32 processed_feeds = 4;
  repeated string failed_feeds = 5;
  string created_at = 6;
  string updated_at = 7;
}

message GetImportJobRequest {
  string id = 1;
}

message GetImportJobResponse {
  ImportJob job = 1;
}

message SetFeedTagsRequest {
  string feed_id = 1;
  repeated string tag_ids = 2;
}

message SetFeedTagsResponse {}

message ManageFeedTagsRequest {
  repeated string feed_ids = 1;
  repeated string add_tag_ids = 2;
  repeated string remove_tag_ids = 3;
}

message ManageFeedTagsResponse {}
